<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Tikettijärjestelmä</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

        html {
            overflow-y: scroll;
        }

        body {
            font-family: "Roboto", sans-serif;
            margin: 80px;
            background-color: #f4f6f8;
            color: #333;
            font-size: 15px;
            line-height: 1.5;
        }

        h2 {
            font-size: 24px;
            margin-bottom: 16px;
        }

        h3 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        h3 div {
            margin-bottom: 4px;
        }

        h3 div:last-child {
            margin-bottom: 0;
        }

        p {
            font-size: 15px;
        }

        #password {
            margin-bottom: 15px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            margin: 6px 0 10px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 15px;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        button {
            padding: 8px 12px;
            font-family: "Roboto", sans-serif;
            font-size: 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.delete-button {
            background-color: #dc3545;
            margin-left: auto;
        }

        button.delete-button:hover {
            background-color: #c82333;
        }

        .submit-btn {
            padding: 8px 12px;
            margin-bottom: 16px;
        }

        .ticket {
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 6px solid #007bff;
            transition: background-color 0.2s ease, border-left-color 0.2s ease;
            font-size: 15px;
        }

        .ticket h3 {
            margin: 0 0 10px;
            font-size: 15px;
            color: #333;
        }

        .ticket a {
            color: #007bff;
            text-decoration: none;
        }

        .ticket p {
            margin-bottom: 16px;
        }

        .ticket a:hover {
            text-decoration: underline;
        }

        #ticketContainer {
            margin-top: 24px;
        }

        #filterSupervisor {
            margin-bottom: 16px;
        }

        .questions p {
            margin: 4px 0;
            font-size: 15px;
        }

        .status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            display: inline-block;
            font-size: 13px;
        }

        .controls {
            margin-top: 10px;
        }

        .controls button {
            margin-right: 8px;
        }

        .no-response {
            border-left-color: #dc3545 !important;
            background-color: #fff0f0;
        }

        .answered {
            border-left-color: #fd7e14 !important;
            background-color: #fff7e5;
        }

        .billable {
            border-left-color: #28a745 !important;
            background-color: #e5ffe5;
        }

        textarea {
            min-height: 60px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            background-color: #f8f9fa;
            color: #007bff;
            border: 1px solid #dee2e6;
        }

        .pagination button.active {
            background-color: #007bff;
            color: white;
        }

        @media (max-width: 600px) {
            body {
                margin: 30px;
                font-size: 14px;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 16px;
            }

            input,
            textarea,
            select,
            button {
                font-size: 16px;
            }

            input,
            textarea,
            select {
                padding: 10px;
            }

            button {
                padding: 10px 18px;
                width: 100%;
                box-sizing: border-box;
                font-size: 14px;
            }

            .submit-btn {
                padding: 10px 18px;
                margin-bottom: 0;
            }

            .controls>div {
                flex-direction: column !important;
                align-items: stretch;
            }

            .controls button {
                width: 100% !important;
                margin: 6px 0 !important;
            }

            .controls {
                margin-top: 0;
                display: flex;
                flex-direction: column;
            }

            .ticket {
                padding: 12px;
            }

            .ticket a {
                word-break: break-all;
            }

            textarea {
                min-height: 100px;
            }

            #formContainer {
                margin-bottom: 24px;
            }
        }
    </style>

</head>

<body>

    <div id="loginDiv" style="display:none;">
        <input id="email" type="email" placeholder="Sähköposti" />
        <input id="password" type="password" placeholder="Salasana" />
        <button onclick="login()">Kirjaudu sisään</button>
    </div>

    <div id="appDiv" style="display:none;">

        <h2>Tikettijärjestelmä</h2>

        <div style="margin-bottom: 12px;">
            <h3>Uusi tarkastuspyyntö</h3> <span id="toggleLink" style="color:#007bff; cursor:pointer;">[Näytä
                lomake]</span>
        </div>

        <div id="formContainer" style="display: none;">
            <select id="supervisor">
                <option value="">Valitse vastuuhenkilö</option>
                <option value="Jari Ruokonen">Jari Ruokonen</option>
                <option value="Juuso Aimonen">Juuso Aimonen</option>
                <option value="Harri Kauppinen">Harri Kauppinen</option>
                <option value="Harri Pyöriä">Harri Pyöriä</option>
                <option value="Mika Kekkonen">Mika Kekkonen</option>
                <option value="Nico Westermark">Nico Westermark</option>
                <option value="Paula Salo">Paula Salo</option>
                <option value="Samuli Järvinen">Samuli Järvinen</option>
                <option value="Sari Makkonen">Sari Makkonen</option>
                <option value="Tarja Penttinen">Tarja Penttinen</option>
            </select><br>
            <input type="text" id="invoiceNumber" placeholder="Laskun tunnus"><br>
            <textarea id="questionText" placeholder="Pyynnön teksti..."></textarea><br>
            <button class="submit-btn" onclick="createTicket()">Luo uusi tarkastuspyyntö</button>
        </div>

        <hr>

        <h3>Tarkastuspyynnöt</h3>
        <select id="filterSupervisor">
            <option value="">Valitse vastuuhenkilö</option>
            <option value="all">Kaikki tarkastuspyynnöt</option>
            <option value="Jari Ruokonen">Jari Ruokonen</option>
            <option value="Juuso Aimonen">Juuso Aimonen</option>
            <option value="Harri Kauppinen">Harri Kauppinen</option>
            <option value="Harri Pyöriä">Harri Pyöriä</option>
            <option value="Mika Kekkonen">Mika Kekkonen</option>
            <option value="Nico Westermark">Nico Westermark</option>
            <option value="Paula Salo">Paula Salo</option>
            <option value="Samuli Järvinen">Samuli Järvinen</option>
            <option value="Sari Makkonen">Sari Makkonen</option>
            <option value="Tarja Penttinen">Tarja Penttinen</option>
        </select>
        <select id="itemsPerPage">
            <option value="10">10 per sivu</option>
            <option value="25">25 per sivu</option>
            <option value="50">50 per sivu</option>
            <option value="100">100 per sivu</option>
        </select>
        <button onclick="window.loadTicketsTriggeredByUser = true; loadTickets();">Lataa</button>

        <div id="ticketContainer">
            <div class="loading" id="loadingIndicator" style="display: none;">Ladataan...</div>
        </div>
        
        <div id="pagination" class="pagination"></div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
            import { getDatabase, ref, push, get, update, remove, query, orderByChild, limitToLast, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
            import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDPvu0I02K_gfbxjAbgZVuyNqoP2s_Onf8",
                authDomain: "tickets-512c1.firebaseapp.com",
                databaseURL: "https://tickets-512c1-default-rtdb.firebaseio.com",
                projectId: "tickets-512c1",
                storageBucket: "tickets-512c1.firebasestorage.app",
                messagingSenderId: "92507230513",
                appId: "1:92507230513:web:38d6e8a6c3beaafdf2e010"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth(app);

            let currentPage = 1;
            let itemsPerPage = 10;
            let allTickets = [];
            let filteredTickets = [];

            window.login = () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        document.getElementById('loginDiv').style.display = 'none';
                        document.getElementById('appDiv').style.display = 'block';
                    })
                    .catch(error => {
                        alert("Kirjautuminen epäonnistui: " + error.message);
                    });
            };

            onAuthStateChanged(auth, user => {
                if (user) {
                    document.getElementById('loginDiv').style.display = 'none';
                    document.getElementById('appDiv').style.display = 'block';

                    if (!window.loadTicketsCalled) {
                        loadTickets();
                        window.loadTicketsCalled = true;
                    }
                } else {
                    document.getElementById('loginDiv').style.display = 'block';
                    document.getElementById('appDiv').style.display = 'none';
                    window.loadTicketsCalled = false;
                }
            });

            function getURLParameter(name) {
                return new URLSearchParams(window.location.search).get(name);
            }

            window.createTicket = async function() {
                const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
                const supervisorSelect = document.getElementById('supervisor');
                const supervisor = supervisorSelect.options[supervisorSelect.selectedIndex].value;
                const questionText = document.getElementById('questionText').value.trim();

                if (!invoiceNumber || supervisor === "" || !questionText) {
                    alert("Täytä kaikki kentät.");
                    return;
                }

                await push(ref(db, 'tickets'), {
                    invoiceNumber,
                    supervisor,
                    status: "ODOTTAA TARKASTUSTA",
                    questions: [
                        { text: questionText, time: Date.now() }
                    ],
                    createdAt: Date.now()
                });

                alert("Pyyntö luotu.");
                document.getElementById('invoiceNumber').value = '';
                document.getElementById('supervisor').selectedIndex = 0;
                document.getElementById('questionText').value = '';
                loadTickets();
            };

            window.loadTickets = async function() {
                const supSelect = document.getElementById('filterSupervisor');
                const supName = supSelect.options[supSelect.selectedIndex].value;
                itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
                currentPage = 1;

                if (supName === "") {
                    if (window.loadTicketsTriggeredByUser) {
                        alert("Valitse vastuuhenkilö.");
                    }
                    return;
                }

                const url = new URL(window.location);
                url.searchParams.set('supervisor', supName);
                window.history.replaceState(null, '', url);

                document.getElementById('loadingIndicator').style.display = 'block';
                const container = document.getElementById('ticketContainer');
                container.innerHTML = '';
                
                try {
                    const snapshot = await get(ref(db, 'tickets'));
                    const tickets = snapshot.val();

                    if (!tickets) {
                        container.innerHTML = '<p>Mitään ei löytynyt.</p>';
                        document.getElementById('loadingIndicator').style.display = 'none';
                        return;
                    }

                    allTickets = Object.entries(tickets)
                        .map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => b.createdAt - a.createdAt);

                    if (supName !== 'all') {
                        filteredTickets = allTickets.filter(ticket => ticket.supervisor === supName);
                    } else {
                        filteredTickets = [...allTickets];
                    }

                    if (filteredTickets.length === 0) {
                        container.innerHTML = '<p>Mitään ei löytynyt.</p>';
                        document.getElementById('loadingIndicator').style.display = 'none';
                        return;
                    }

                    renderTicketsForCurrentPage();
                    setupPagination();
                    
                } catch (error) {
                    console.error("Error loading tickets:", error);
                    container.innerHTML = '<p>Virhe tietojen lataamisessa.</p>';
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            };

            function renderTicketsForCurrentPage() {
                const container = document.getElementById('ticketContainer');
                container.innerHTML = '';
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageTickets = filteredTickets.slice(startIndex, endIndex);

                if (pageTickets.length === 0) {
                    container.innerHTML = '<p>Mitään ei löytynyt.</p>';
                    return;
                }

                pageTickets.forEach(data => {
                    const div = document.createElement('div');
                    div.className = 'ticket';

                    if (data.status === "SAA LASKUTTAA") {
                        div.classList.add('billable');
                    } else if (data.status === "KESKEN" || (data.questions && data.questions.length > 1)) {
                        div.classList.add('answered');
                    } else {
                        div.classList.add('no-response');
                        if (data.status !== "KESKEN") {
                            data.status = "ODOTTAA TARKASTUSTA";
                        }
                    }

                    const questionsHtml = `
                        <div class="questions">
                            ${data.questions.map((q, index) => {
                                const date = new Date(q.time);
                                const formattedDate = date.toLocaleString('fi-FI', {
                                    year: 'numeric',
                                    month: 'numeric',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                const deleteBtn = index > 0 
                                    ? `<span style="cursor:pointer; margin-left:8px;" title="Poista vastaus" onclick="deleteAnswer('${data.id}', ${index})">🗑</span>`
                                    : '';
                                return `<p><strong>${formattedDate}:</strong> ${q.text}${deleteBtn}</p>`;
                            }).join('')}
                        </div>
                    `;

                    div.innerHTML = `
                        <h3>
                            <div class="supervisor">
                                Vastuuhenkilö: ${data.supervisor}
                            </div>
                            <div class="invoice-number">
                                Laskun tunnus: <a href="https://laskutus.iss.fi/invoice/${data.invoiceNumber}" target="_blank">${data.invoiceNumber}</a>
                            </div>
                        </h3>
                        <p><strong>Pyynnön tila:</strong> <span class="status">${data.status}</span></p>
                        ${questionsHtml}
                        <textarea style="margin-bottom: 0px;" placeholder="Kirjoita vastaus..." id="followup-${data.id}"></textarea><br>
                        <div class="controls">
                            <div style="display: flex; align-items: center;">
                                <div>
                                    <button onclick="addFollowUp('${data.id}')">✉&ensp;Tallenna vastaus</button>
                                    <button onclick="updateStatus('${data.id}', 'KESKEN')">👁&ensp;Tarkastettavana</button>
                                    <button onclick="updateStatus('${data.id}', 'SAA LASKUTTAA')">✔&ensp;Saa laskuttaa</button>
                                </div>
                                <button class="delete-button" onclick="deleteTicket('${data.id}')">🗑&ensp;Poista pyyntö</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            function setupPagination() {
                const paginationDiv = document.getElementById('pagination');
                paginationDiv.innerHTML = '';
                
                const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
                
                if (totalPages <= 1) return;
                
                if (currentPage > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'Edellinen';
                    prevBtn.onclick = () => {
                        currentPage--;
                        renderTicketsForCurrentPage();
                        setupPagination();
                    };
                    paginationDiv.appendChild(prevBtn);
                }
                
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    if (i === currentPage) {
                        pageBtn.classList.add('active');
                    }
                    pageBtn.onclick = () => {
                        currentPage = i;
                        renderTicketsForCurrentPage();
                        setupPagination();
                    };
                    paginationDiv.appendChild(pageBtn);
                }
                
                if (currentPage < totalPages) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Seuraava';
                    nextBtn.onclick = () => {
                        currentPage++;
                        renderTicketsForCurrentPage();
                        setupPagination();
                    };
                    paginationDiv.appendChild(nextBtn);
                }
            }

            window.addFollowUp = async function(id) {
                const followUpText = document.getElementById(`followup-${id}`).value.trim();
                if (!followUpText) return;

                const ticketRef = ref(db, `tickets/${id}`);

                const snapshot = await get(ticketRef);
                const ticket = snapshot.val();

                if (!ticket) return;

                const updatedQuestions = ticket.questions ? [...ticket.questions] : [];
                updatedQuestions.push({ text: followUpText, time: Date.now() });

                await update(ticketRef, {
                    questions: updatedQuestions,
                    status: "VASTATTU"
                });

                alert("Vastaus lisätty.");
                loadTickets();
            };

            window.onload = () => {
                if (window.loadTicketsCalled) return;
                window.loadTicketsCalled = true;

                const supervisorFromURL = getURLParameter('supervisor');
                if (supervisorFromURL) {
                    const select = document.getElementById('filterSupervisor');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === supervisorFromURL) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                    loadTickets();
                }
                
                document.getElementById('itemsPerPage').addEventListener('change', () => {
                    if (window.loadTicketsCalled) {
                        currentPage = 1;
                        renderTicketsForCurrentPage();
                        setupPagination();
                    }
                });
            };

            window.updateStatus = async function(id, newStatus) {
                const ticketRef = ref(db, `tickets/${id}`);
                await update(ticketRef, {
                    status: newStatus
                });
                alert("Pyynnön tila päivitetty.");
                loadTickets();
            };

            window.deleteAnswer = async function(ticketId, answerIndex) {
                if (!confirm("Haluatko varmasti poistaa tämän vastauksen?")) return;

                const ticketRef = ref(db, `tickets/${ticketId}`);
                const snapshot = await get(ticketRef);
                const ticket = snapshot.val();

                if (!ticket || !ticket.questions || ticket.questions.length <= answerIndex) {
                    alert("Vastausta ei löytynyt.");
                    return;
                }

                const updatedQuestions = ticket.questions.filter((_, i) => i !== answerIndex);
                const newStatus = updatedQuestions.length === 1 ? "ODOTTAA TARKASTUSTA" : ticket.status;

                await update(ticketRef, {
                    questions: updatedQuestions
                });

                alert("Vastaus poistettu.");
                loadTickets();
            };

            window.deleteTicket = async function(id) {
                if (!confirm("Haluatko varmasti poistaa tämän pyynnön?")) return;

                await remove(ref(db, `tickets/${id}`));
                alert("Pyyntö poistettu.");
                loadTickets();
            };

            const toggleLink = document.getElementById("toggleLink");
            const formContainer = document.getElementById("formContainer");

            toggleLink.addEventListener("click", () => {
                const isVisible = formContainer.style.display === "block";
                formContainer.style.display = isVisible ? "none" : "block";
                toggleLink.textContent = isVisible ? "[Näytä lomake]" : "[Piilota lomake]";
            });
        </script>

    </div>

</body>

</html>